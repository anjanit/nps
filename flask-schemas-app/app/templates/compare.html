{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h1>Compare NPS Schemes</h1>
    
    <div class="scheme-selector">
        <label>Select Schemes to Compare (multiple):</label>
        <div class="scheme-checkboxes">
            {% for scheme in schemes %}
            <div class="checkbox-item">
                <input type="checkbox" id="scheme_{{ scheme.scheme_code }}" 
                       name="scheme" value="{{ scheme.scheme_code }}">
                <label for="scheme_{{ scheme.scheme_code }}">
                    {{ scheme.scheme_code }} - {{ scheme.scheme_name }}
                </label>
            </div>
            {% endfor %}
        </div>
        <button id="compareBtn" class="btn-compare">Compare Selected Schemes</button>
    </div>

    <div id="chartContainer" style="display: none; margin-top: 20px;">
        <canvas id="compareChart"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let chart = null;
    const compareBtn = document.getElementById('compareBtn');
    const chartContainer = document.getElementById('chartContainer');
    
    // Color palette for different schemes
    const colors = [
        { border: 'rgba(75, 192, 192, 1)', background: 'rgba(75, 192, 192, 0.2)' },
        { border: 'rgba(255, 99, 132, 1)', background: 'rgba(255, 99, 132, 0.2)' },
        { border: 'rgba(54, 162, 235, 1)', background: 'rgba(54, 162, 235, 0.2)' },
        { border: 'rgba(255, 206, 86, 1)', background: 'rgba(255, 206, 86, 0.2)' },
        { border: 'rgba(153, 102, 255, 1)', background: 'rgba(153, 102, 255, 0.2)' },
        { border: 'rgba(255, 159, 64, 1)', background: 'rgba(255, 159, 64, 0.2)' }
    ];
    
    compareBtn.addEventListener('click', async function() {
        const checkboxes = document.querySelectorAll('input[name="scheme"]:checked');
        const schemeCodes = Array.from(checkboxes).map(cb => cb.value);
        
        if (schemeCodes.length === 0) {
            alert('Please select at least one scheme to compare');
            return;
        }
        
        // Show loading indicator
        compareBtn.disabled = true;
        compareBtn.textContent = 'Loading...';
        
        try {
            const response = await fetch('/api/schemes/compare', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ scheme_codes: schemeCodes })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Received data:', data);
            
            if (data.error) {
                alert(data.error);
                return;
            }
            
            if (!data.datasets || data.datasets.length === 0) {
                alert('No data found for selected schemes');
                return;
            }
            
            if (chart) {
                chart.destroy();
            }
            
            chartContainer.style.display = 'block';
            const ctx = document.getElementById('compareChart').getContext('2d');
            
            // Reduce data points for better performance - sample every 5th point
            const sampleRate = 5;
            
            // Create datasets for each scheme - use their own dates instead of aligning
            const datasets = data.datasets.map((dataset, index) => {
                const colorIndex = index % colors.length;
                
                // Sample the data to reduce points
                const sampledDates = dataset.dates.filter((_, i) => i % sampleRate === 0);
                const sampledData = dataset.data.filter((_, i) => i % sampleRate === 0);
                
                return {
                    label: dataset.label,
                    data: sampledDates.map((date, i) => ({
                        x: date,
                        y: sampledData[i]
                    })),
                    backgroundColor: colors[colorIndex].background,
                    borderColor: colors[colorIndex].border,
                    borderWidth: 2,
                    fill: false,
                    pointRadius: 1
                };
            });
            
            console.log('Creating chart with datasets:', datasets);
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        x: {
                            type: 'category',
                            title: {
                                display: true,
                                text: 'Date'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 20
                            }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'NAV'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
            
            console.log('Chart created successfully');
        } catch (error) {
            console.error('Error fetching comparison data:', error);
            alert('Failed to fetch comparison data: ' + error.message);
        } finally {
            compareBtn.disabled = false;
            compareBtn.textContent = 'Compare Selected Schemes';
        }
    });
</script>

<style>
    .scheme-checkboxes {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 15px;
        margin: 10px 0;
        border-radius: 4px;
    }
    
    .checkbox-item {
        padding: 5px 0;
    }
    
    .checkbox-item input[type="checkbox"] {
        margin-right: 10px;
    }
    
    .btn-compare {
        background-color: #4CAF50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
    }
    
    .btn-compare:hover {
        background-color: #45a049;
    }
    
    #chartContainer {
        padding: 20px;
        background-color: #f9f9f9;
        border-radius: 4px;
    }
</style>
{% endblock %}
